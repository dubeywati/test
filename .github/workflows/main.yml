name: Main Branch PR Workflow

on:
  workflow_dispatch:
    inputs:
      branch_name:
        required: true
        type: string
  pull_request:
    types:
      - opened

env:
  username: "${{ github.actor }}"
  branch: "${{ github.event.inputs.branch_name }}"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: oNaiPs/secrets-to-env-action@v1
      with:
        secrets: ${{ toJSON(secrets) }}

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    - name: Build
      run: dotnet build --configuration Release

    - name: Execute Regression Test
      run: dotnet test --logger "trx;LogFileName=test-results.trx"

    - name: Generate Regression Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Regression Test Report
        path: "**/test-results.trx"
        reporter: dotnet-trx
        fail-on-error: true

    - name: Add Comment to PR
      
      run: |
        PR_NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH")
        COMMENT="Your comment goes here."
        API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments"
        echo "{\"body\": \"${COMMENT}\"}" | curl -X POST -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" -d @- ${API_URL}
